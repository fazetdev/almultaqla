// SmartOps Gulf Dashboard - Production Database Schema
// Multi-industry, Arabic/English, Gulf-region focused

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"  // New requirement for Prisma 7
  previewFeatures = ["fullTextSearchPostgres", "views"]
}

datasource db {
  provider = "postgresql"
  // Note: url and relationMode moved to prisma.config.ts for Prisma 7
}

// ============== CORE ORGANIZATION STRUCTURE ==============
model Organization {
  id                String            @id @default(cuid())
  name              String
  nameAr            String?           // Arabic name
  industry          IndustryType
  subdomain         String?           @unique
  timezone          String            @default("Asia/Riyadh")
  language          String            @default("ar")
  logoUrl           String?
  theme             Json?             // Custom theme colors
  settings          Json?             // Organization-specific settings
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  users             User[]
  customers         Customer[]
  services          Service[]
  staff             Staff[]
  bookings          Booking[]
  payments          Payment[]
  analyticsEvents   AnalyticsEvent[]
  industryConfig    IndustryConfig?
  staffPerformances StaffPerformance[]
  notifications     Notification[]

  @@index([industry])
  @@index([subdomain])
  @@unique([name, industry])
}

enum IndustryType {
  SALON_SPA
  CLINIC_MEDICAL
  RETAIL_STORE
  DELIVERY_SERVICE
  SCHOOL_ACADEMY
}

// ============== AUTHENTICATION & USERS ==============
model User {
  id              String        @id @default(cuid())
  email           String        @unique
  phone           String?
  passwordHash    String
  name            String
  nameAr          String?
  avatarUrl       String?
  role            UserRole      @default(CUSTOMER)
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  isVerified      Boolean       @default(false)
  isActive        Boolean       @default(true)
  lastLoginAt     DateTime?
  preferences     Json?         // User preferences
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  staffProfile    Staff?
  customerProfile Customer?
  sessions        Session[]
  notifications   Notification[]

  @@index([email, organizationId])
  @@index([organizationId, role])
}

enum UserRole {
  SUPER_ADMIN
  ORGANIZATION_ADMIN
  STAFF
  CUSTOMER
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ============== CUSTOMERS ==============
model Customer {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?       @unique
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  name           String
  email          String?       @unique
  phone          String?       @unique
  lastVisit      DateTime?
  totalSpent     Float         @default(0)
  notes          String?
  
  nameAr         String?
  gender         GenderType?
  dateOfBirth    DateTime?
  nationality    String?
  
  customFields   Json?
  
  addressLine1   String?
  addressLine2   String?
  city           String?
  state          String?
  country        String?       @default("SA")
  postalCode     String?
  
  tags           String[]      
  totalBookings  Int           @default(0)
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  bookings       Booking[]
  payments       Payment[]
  
  @@unique([phone, organizationId])
  @@unique([email, organizationId])
  @@index([organizationId, createdAt])
  @@index([organizationId, totalSpent])
  @@index([organizationId, lastVisit])
}

enum GenderType {
  MALE
  FEMALE
  OTHER
}

// ============== STAFF ==============
model Staff {
  id                String        @id @default(cuid())
  organizationId    String
  organization      Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId            String?       @unique
  user              User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  name              String
  role              String        
  email             String?       @unique
  phone             String?
  performanceScore  Float         @default(0)
  
  nameAr            String?
  title             String?       
  bio               String?
  bioAr             String?
  
  schedule          Json?         
  workingHours      Json?         
  isActive          Boolean       @default(true)
  
  customFields      Json?
  
  avatarUrl         String?
  documents         Json?         
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  services          Service[]     @relation("ServiceStaff")
  bookings          Booking[]
  performances      StaffPerformance[]
  
  @@index([organizationId, role])
  @@index([organizationId, isActive])
}

// ============== SERVICES ==============
model Service {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name           String
  category       String
  duration       Int           
  price          Float
  description    String?
  
  nameAr         String?
  descriptionAr  String?
  categoryAr     String?
  
  isActive       Boolean       @default(true)
  requiresStaff  Boolean       @default(true)
  currency       String        @default("SAR")
  
  subcategory    String?
  type           String?       
  
  staff          Staff[]       @relation("ServiceStaff")
  bookingSlots   Json?         
  
  customFields   Json?
  
  imageUrl       String?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  bookings       Booking[]
  
  @@index([organizationId, category])
  @@index([organizationId, price])
  @@index([organizationId, isActive])
}

// ============== BOOKINGS ==============
model Booking {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  customerId     String
  customer       Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  date           DateTime
  type           String
  status         BookingStatus @default(PENDING)
  amount         Float
  notes          String?
  
  endDate        DateTime?     
  staffId        String?
  staff          Staff?        @relation(fields: [staffId], references: [id], onDelete: SetNull)
  serviceId      String?
  service        Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  
  industryType   IndustryType
  customFields   Json?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  cancelledAt    DateTime?
  confirmedAt    DateTime?
  completedAt    DateTime?
  
  payment        Payment?
  
  @@index([organizationId, date])
  @@index([organizationId, status])
  @@index([organizationId, customerId])
  @@index([organizationId, staffId])
  @@index([date, status])
  @@index([customerId, date])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============== PAYMENTS ==============
model Payment {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  bookingId      String?       @unique
  booking        Booking?      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customerId     String
  customer       Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  amount         Float
  method         PaymentMethod
  status         PaymentStatus @default(PENDING)
  date           DateTime
  
  receiptNumber  String        @unique
  currency       String        @default("SAR")
  
  methodAr       String?
  
  transactionId  String?       @unique
  gateway        String?       
  gatewayData    Json?         
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  paidAt         DateTime?
  failedAt       DateTime?
  
  @@index([organizationId, date])
  @@index([organizationId, status])
  @@index([organizationId, customerId])
  @@index([organizationId, bookingId])
  @@index([receiptNumber])
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  MADA
  APPLE_PAY
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_PAID
}

// ============== ANALYTICS & PERFORMANCE ==============
model AnalyticsEvent {
  id             String             @id @default(cuid())
  organizationId String
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  eventType      AnalyticsEventType
  entityType     String             
  entityId       String?
  data           Json               
  
  revenue        Float?             @default(0)
  duration       Int?               
  count          Int                @default(1)
  
  eventDate      DateTime           
  createdAt      DateTime           @default(now())
  
  @@index([organizationId, eventType, eventDate])
  @@index([organizationId, eventDate])
  @@index([eventType, eventDate])
}

enum AnalyticsEventType {
  BOOKING_CREATED
  BOOKING_CONFIRMED
  BOOKING_COMPLETED
  BOOKING_CANCELLED
  PAYMENT_RECEIVED
  CUSTOMER_CREATED
  STAFF_PERFORMANCE
  SERVICE_BOOKED
}

model StaffPerformance {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  staffId        String
  staff          Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  period         DateTime      
  periodType     PeriodType    
  bookingsCount  Int           @default(0)
  revenue        Float         @default(0)
  rating         Float?        
  hoursWorked    Float?        @default(0)
  
  efficiencyScore Float?       @default(0)
  qualityScore    Float?       @default(0)
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@unique([organizationId, staffId, period, periodType])
  @@index([organizationId, period])
  @@index([staffId, period])
}

enum PeriodType {
  DAILY
  WEEKLY
  MONTHLY
}

// ============== ANALYTICS VIEWS ==============
view WeeklyRevenueView {
  organizationId String    @map("organization_id")
  weekStart      DateTime  @map("week_start")
  revenue        Float
  
  @@map("weekly_revenue_view")
  @@ignore
}

view StaffPerformanceView {
  organizationId   String  @map("organization_id")
  staffId          String  @map("staff_id")
  staffName        String  @map("staff_name")
  staffNameAr      String? @map("staff_name_ar")
  periodStart      DateTime @map("period_start")
  revenue          Float
  bookings          Int
  
  @@map("staff_performance_view")
  @@ignore
}

view PopularServicesView {
  organizationId   String  @map("organization_id")
  serviceId        String  @map("service_id")
  serviceName      String  @map("service_name")
  serviceNameAr    String? @map("service_name_ar")
  bookingCount     Int     @map("booking_count")
  revenue          Float
  
  @@map("popular_services_view")
  @@ignore
}

view PeakHoursView {
  organizationId   String  @map("organization_id")
  hour               Int
  bookings           Int
  
  @@map("peak_hours_view")
  @@ignore
}

// ============== INDUSTRY CONFIGURATION ==============
model IndustryConfig {
  id             String        @id @default(cuid())
  organizationId String        @unique
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  terminology    Json          
  businessHours  Json
  bookingRules   Json?
  settings       Json?
  
  updatedAt      DateTime      @updatedAt
  createdAt      DateTime      @default(now())
}

// ============== NOTIFICATIONS ==============
model Notification {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title          String
  titleAr        String?
  message        String
  messageAr      String?
  type           NotificationType
  
  isRead         Boolean       @default(false)
  priority       PriorityLevel @default(MEDIUM)
  actionUrl      String?       
  
  createdAt      DateTime      @default(now())
  readAt         DateTime?
  
  @@index([organizationId, userId, isRead])
  @@index([organizationId, createdAt])
}

enum NotificationType {
  BOOKING_REMINDER
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  SYSTEM_ALERT
  STAFF_ASSIGNMENT
}

enum PriorityLevel {
  LOW
  MEDIUM
  HIGH
  URGENT
}